name: Sync Commit to ProjectV2

on:
  push:
    branches:
      - main  # 替换为你主分支名称

jobs:
  update-project:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout 代码
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. 获取最新 commit 信息
      - name: Get latest commit message and author
        id: commit
        run: |
          COMMIT_TITLE=$(git log -1 --pretty=format:"%s")
          COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
          COMMIT_DATE=$(git log -1 --pretty=format:"%Y-%m-%d" --no-merges)
          COMMIT_AUTHOR_EMAIL=$(git log -1 --pretty=format:"%ae")
          COMMIT_URL="${{ github.event.head_commit.url }}"
          echo "COMMIT_TITLE=$COMMIT_TITLE" >> $GITHUB_ENV
          echo "COMMIT_AUTHOR=$COMMIT_AUTHOR" >> $GITHUB_ENV
          echo "COMMIT_DATE=$COMMIT_DATE" >> $GITHUB_ENV
          echo "COMMIT_AUTHOR_EMAIL=$COMMIT_AUTHOR_EMAIL" >> $GITHUB_ENV
          echo "COMMIT_URL=$COMMIT_URL" >> $GITHUB_ENV

      # 3. 创建 Issue 并添加到 ProjectV2
      - name: Add card to ProjectV2
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const { syncCommitToProject } = require('./.github/scripts/sync-to-project.js');
            
            // 设置环境变量
            process.env.PROJECT_ID = 'PVT_kwHOCoF7pM4BFUrC';
            process.env.COMMIT_TITLE = process.env.COMMIT_TITLE;
            process.env.COMMIT_AUTHOR = process.env.COMMIT_AUTHOR;
            process.env.COMMIT_DATE = process.env.COMMIT_DATE;
            process.env.COMMIT_AUTHOR_EMAIL = process.env.COMMIT_AUTHOR_EMAIL;
            process.env.REPO_OWNER = context.repo.owner;
            process.env.REPO_NAME = context.repo.repo;
            process.env.COMMIT_SHA = context.sha;
            process.env.COMMIT_URL = process.env.COMMIT_URL;
            
            // 执行同步脚本，传递 github 对象
            const result = await syncCommitToProject(github);
            console.log('同步结果:', result);
