name: SmartHire Backend CD

on:
  workflow_run:
    workflows: ["SmartHire Backend CI"]
    types:
      - completed
    branches: [main]

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      # 1. Ê£ÄÊü• CI Â∑•‰ΩúÊµÅÁä∂ÊÄÅ
      - name: Check CI workflow status
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "‚ùå CI Â∑•‰ΩúÊµÅÊú™ÊàêÂäüÂÆåÊàêÔºåÁä∂ÊÄÅ‰∏∫: ${{ github.event.workflow_run.conclusion }}"
            echo "üö´ ÈÉ®ÁΩ≤Â∑≤ÂèñÊ∂àÔºåËØ∑ÂÖà‰øÆÂ§ç CI Â§±Ë¥•ÈóÆÈ¢ò"
            exit 1
          else
            echo "‚úÖ CI Â∑•‰ΩúÊµÅÊàêÂäüÂÆåÊàêÔºåÂºÄÂßãÈÉ®ÁΩ≤ÊµÅÁ®ã"
          fi

      # 2. Ëé∑ÂèñÁâàÊú¨Âè∑Ôºà‰ªé pom.xmlÔºâ
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ÈúÄË¶ÅËé∑ÂèñÊâÄÊúâ tag ‰ø°ÊÅØ

      - name: Install xmllint
        run: sudo apt-get update && sudo apt-get install -y libxml2-utils

      - name: Get version from pom.xml
        id: get_version
        shell: bash
        run: |
          # ‰ªé pom.xml Ëé∑ÂèñÊúÄÊñ∞ÁâàÊú¨
          VERSION=$(xmllint --xpath "//*[local-name()='project']/*[local-name()='version']/text()" SmartHire_Backend/pom.xml)
          CLEAN_VERSION="${VERSION/-SNAPSHOT/}"
          TAG="v$CLEAN_VERSION"
          echo "VERSION=$CLEAN_VERSION" >> $GITHUB_OUTPUT
          echo "Using version from pom.xml: $TAG"
          
          # ËÆæÁΩÆÊúÄÁªàÁöÑ IMAGE_TAG
          echo "IMAGE_TAG=$TAG" >> $GITHUB_OUTPUT
          echo "IMAGE_NAME=${{ secrets.IMAGE_NAME }}" >> $GITHUB_OUTPUT
          echo "Final image tag: $TAG"
          echo "Deploying image: ghcr.io/${{ github.repository_owner }}/${{ secrets.IMAGE_NAME }}:$TAG"

      # 3. ÈÖçÁΩÆ SSH
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      # 4. Ê∑ªÂä†ÊúçÂä°Âô®Âà∞ known_hostsÔºàÈÅøÂÖçÈ¶ñÊ¨°ËøûÊé•Á°ÆËÆ§Ôºâ
      - name: Add server to known_hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      # 5. ÈÉ®ÁΩ≤Âà∞ÊúçÂä°Âô®
      - name: Deploy to server
        env:
          SMARTHIRE_TOKEN: ${{ secrets.SMARTHIRE_TOKEN }}
          IMAGE_NAME: ${{ secrets.IMAGE_NAME }}
          IMAGE_TAG: ${{ steps.get_version.outputs.IMAGE_TAG || 'latest' }}
          REPO_OWNER: ${{ github.repository_owner }}
          # ‰ΩøÁî® workflow_run.actor
          GH_ACTOR: ${{ github.event.workflow_run.actor.login }}
        run: |
          ssh -tt \
          -o ServerAliveInterval=30 \
          -o ServerAliveCountMax=10 \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << EOF
            set -Eeuo pipefail
            echo "=== ÂºÄÂßãÈÉ®ÁΩ≤ ==="
            echo "ÈïúÂÉè: ghcr.io/$REPO_OWNER/$IMAGE_NAME:$IMAGE_TAG"
            
            # ËøõÂÖ•È°πÁõÆÁõÆÂΩï
            cd /opt/smarthire/backend
            
            # ÁôªÂΩï GitHub Container RegistryÔºàÂú®ÊúçÂä°Âô®‰∏äÔºâ
            echo "$SMARTHIRE_TOKEN" | docker login ghcr.io -u $GH_ACTOR --password-stdin
            
            # ÊãâÂèñÊúÄÊñ∞ÈïúÂÉè
            echo "ÊãâÂèñ Docker ÈïúÂÉè..."
            docker pull ghcr.io/$REPO_OWNER/$IMAGE_NAME:$IMAGE_TAG
            
            # ÂÅúÊ≠¢ÊóßÂÆπÂô®
            echo "ÂÅúÊ≠¢ÊóßÂÆπÂô®..."
            docker-compose down || true
            
            # Êõ¥Êñ∞ÈïúÂÉèÊ†áÁ≠æ‰∏∫ latestÔºàdocker-compose.yml ÈáåÁî®ÁöÑÊòØ smarthire-backend:latestÔºâ
            docker tag ghcr.io/$REPO_OWNER/$IMAGE_NAME:$IMAGE_TAG $IMAGE_NAME:latest
            
            # ÂêØÂä®Êñ∞ÂÆπÂô®
            echo "ÂêØÂä®Êñ∞ÂÆπÂô®..."
            docker-compose up -d
            
            # Á≠âÂæÖÂÆπÂô®ÂêØÂä®
            sleep 10
            
            # Ê£ÄÊü•ÂÆπÂô®Áä∂ÊÄÅ
            echo "Ê£ÄÊü•ÂÆπÂô®Áä∂ÊÄÅ..."
            docker ps | grep $IMAGE_NAME || echo "‚ö†Ô∏è  ÂÆπÂô®Êú™ËøêË°å"
            
            # Ê£ÄÊü•ÂÆπÂô®ÁΩëÁªú
            echo "Ê£ÄÊü•ÂÆπÂô®ÁΩëÁªú..."
            docker network ls | grep smarthire || echo "‚ö†Ô∏è  ÂÆπÂô®ÁΩëÁªú‰∏çÂ≠òÂú®"
            
            # ÊµãËØïÂÆπÂô®ÂÜÖÈÉ®ÂÅ•Â∫∑Ê£ÄÊü•
            echo "ÊµãËØïÂÆπÂô®ÂÜÖÈÉ®ÂÅ•Â∫∑Ê£ÄÊü•..."
            docker-compose exec -T backend curl -fs \
              --retry 10 \
              --retry-delay 3 \
              --retry-connrefused \
              http://localhost:8080/smarthire/api/health
            
            # Êü•ÁúãÊó•ÂøóÔºàÊúÄÂêé 30 Ë°åÔºâ
            echo "=== ÂÆπÂô®Êó•ÂøóÔºàÊúÄÂêé 30 Ë°åÔºâ==="
            docker-compose logs --tail=30 || echo "Êó†Ê≥ïËé∑ÂèñÊó•Âøó"
            
            # Ê£ÄÊü•Á´ØÂè£Êò†Â∞Ñ
            echo "Ê£ÄÊü•Á´ØÂè£Êò†Â∞Ñ..."
            docker port $IMAGE_NAME || echo "‚ö†Ô∏è  Êó†Ê≥ïËé∑ÂèñÁ´ØÂè£Êò†Â∞Ñ"
            
            echo "=== ÈÉ®ÁΩ≤ÂÆåÊàê ==="
          EOF

      # 6. ÂÅ•Â∫∑Ê£ÄÊü•
      - name: Health check
        run: |
          echo "Á≠âÂæÖÊúçÂä°ÂêØÂä®..."
          sleep 10
          
          # ‰ΩøÁî®ÂÅ•Â∫∑Ê£ÄÊü•Êé•Âè£
          echo "Ê£ÄÊü•Nginx‰ª£ÁêÜÁöÑÂÅ•Â∫∑Ê£ÄÊü•Êé•Âè£..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SERVER_HOST }}/health || echo "000")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Nginx‰ª£ÁêÜÂÅ•Â∫∑Ê£ÄÊü•ÈÄöËøá (HTTP $HTTP_CODE)"
            # ÊòæÁ§∫ÂÅ•Â∫∑Ê£ÄÊü•ÂìçÂ∫îÂÜÖÂÆπ
            curl -s http://${{ secrets.SERVER_HOST }}/health | head -20
          else
            echo "‚ö†Ô∏è  Nginx‰ª£ÁêÜÂÅ•Â∫∑Ê£ÄÊü•Â§±Ë¥• (HTTP $HTTP_CODE)"
            echo "Â∞ùËØïÁõ¥Êé•ËÆøÈóÆÂêéÁ´ØÊúçÂä°..."
            
            # Â∞ùËØïÁõ¥Êé•ËÆøÈóÆÂêéÁ´ØÊúçÂä°
            HTTP_CODE_DIRECT=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SERVER_HOST }}:8080/smarthire/api/health || echo "000")
            if [ "$HTTP_CODE_DIRECT" = "200" ]; then
              echo "‚úÖ Áõ¥Êé•ËÆøÈóÆÂêéÁ´ØÊúçÂä°ÂÅ•Â∫∑Ê£ÄÊü•ÈÄöËøá (HTTP $HTTP_CODE_DIRECT)"
              echo "ÂèØËÉΩÊòØNginxÈÖçÁΩÆÈóÆÈ¢ò"
            else
              echo "‚ö†Ô∏è  Áõ¥Êé•ËÆøÈóÆÂêéÁ´ØÊúçÂä°‰πüÂ§±Ë¥• (HTTP $HTTP_CODE_DIRECT)"
            fi
            echo "ËØ∑ÊâãÂä®Ê£ÄÊü•ÊúçÂä°Âô®Êó•ÂøóÔºödocker logs ${{ secrets.IMAGE_NAME }}"
            # ËøôÈáå‰∏ç failÔºåÂè™ÊòØË≠¶Âëä
          fi
          
          # ÊµãËØïÂÖ¨ÂºÄÊé•Âè£
          echo "ÊµãËØïÂÖ¨ÂºÄÊé•Âè£..."
          SEEKER_CARDS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://${{ secrets.SERVER_HOST }}/smarthire/api/seeker/public/cards?pageNum=1&pageSize=1" || echo "000")
          if [ "$SEEKER_CARDS_CODE" = "200" ]; then
            echo "‚úÖ Ê±ÇËÅåËÄÖÂç°ÁâáÊé•Âè£ÊµãËØïÈÄöËøá (HTTP $SEEKER_CARDS_CODE)"
          else
            echo "‚ö†Ô∏è  Ê±ÇËÅåËÄÖÂç°ÁâáÊé•Âè£ÊµãËØïÂ§±Ë¥• (HTTP $SEEKER_CARDS_CODE)"
          fi

