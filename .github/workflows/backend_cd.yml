name: SmartHire Backend CD

on:
  workflow_run:
    workflows: ["SmartHire Backend CI"]
    types:
      - completed
    branches: [main]

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      # 1Ô∏è‚É£ Ê£ÄÊü• CI Áä∂ÊÄÅ
      - name: Check CI workflow status
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "‚ùå CI Êú™ÊàêÂäüÂÆåÊàêÔºåÁªàÊ≠¢ÈÉ®ÁΩ≤"
            exit 1
          fi
          echo "‚úÖ CI ÊàêÂäüÔºåÂºÄÂßãÈÉ®ÁΩ≤"

      # 2Ô∏è‚É£ Êãâ‰ª£Á†ÅÔºàÁî®‰∫éËØªÂèñ pom.xmlÔºâ
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install xmllint
        run: sudo apt-get update && sudo apt-get install -y libxml2-utils

      - name: Get version from pom.xml
        id: get_version
        shell: bash
        run: |
          VERSION=$(xmllint --xpath "//*[local-name()='project']/*[local-name()='version']/text()" SmartHire_Backend/pom.xml)
          CLEAN_VERSION="${VERSION/-SNAPSHOT/}"
          TAG="v$CLEAN_VERSION"

          echo "IMAGE_TAG=$TAG" >> $GITHUB_OUTPUT
          echo "IMAGE_NAME=${{ secrets.IMAGE_NAME }}" >> $GITHUB_OUTPUT

          echo "üì¶ Deploy image: ghcr.io/${{ github.repository_owner }}/${{ secrets.IMAGE_NAME }}:$TAG"

      # 3Ô∏è‚É£ SSH ÈÖçÁΩÆ
      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Add server to known_hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      # 4Ô∏è‚É£ Ê≠£ÂºèÈÉ®ÁΩ≤
      - name: Deploy to server
        env:
          SMARTHIRE_TOKEN: ${{ secrets.SMARTHIRE_TOKEN }}
          IMAGE_NAME: ${{ secrets.IMAGE_NAME }}
          IMAGE_TAG: ${{ steps.get_version.outputs.IMAGE_TAG }}
          REPO_OWNER: ${{ github.repository_owner }}
          GH_ACTOR: ${{ github.event.workflow_run.actor.login }}
        run: |
          ssh -T \
            -o ServerAliveInterval=30 \
            -o ServerAliveCountMax=10 \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << EOF

          set -Eeuo pipefail

          echo "üöÄ SmartHire Backend ÂºÄÂßãÈÉ®ÁΩ≤"
          echo "üì¶ ÈïúÂÉè: ghcr.io/$REPO_OWNER/$IMAGE_NAME:$IMAGE_TAG"

          cd /opt/smarthire/backend

          echo "$SMARTHIRE_TOKEN" | docker login ghcr.io -u "$GH_ACTOR" --password-stdin

          docker pull --progress=plain ghcr.io/$REPO_OWNER/$IMAGE_NAME:$IMAGE_TAG

          docker-compose down || true
          docker tag ghcr.io/$REPO_OWNER/$IMAGE_NAME:$IMAGE_TAG $IMAGE_NAME:latest
          docker-compose up -d

          echo "‚úÖ ÈÉ®ÁΩ≤ÂÆåÊàê"
          EOF
