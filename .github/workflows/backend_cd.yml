name: SmartHire Backend CD

on:
  workflow_run:
    workflows: ["SmartHire Backend CI"]
    types:
      - completed
    branches: [main]

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      # 1ï¸âƒ£ æ£€æŸ¥ CI çŠ¶æ€
      - name: Check CI workflow status
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "âŒ CI æœªæˆåŠŸå®Œæˆï¼Œç»ˆæ­¢éƒ¨ç½²"
            exit 1
          fi
          echo "âœ… CI æˆåŠŸï¼Œå¼€å§‹éƒ¨ç½²"

      # 2ï¸âƒ£ æ‹‰ä»£ç ï¼ˆç”¨äºè¯»å– pom.xmlï¼‰
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install xmllint
        run: sudo apt-get update && sudo apt-get install -y libxml2-utils

      - name: Get version from pom.xml
        id: get_version
        shell: bash
        run: |
          VERSION=$(xmllint --xpath "//*[local-name()='project']/*[local-name()='version']/text()" SmartHire_Backend/pom.xml)
          CLEAN_VERSION="${VERSION/-SNAPSHOT/}"
          TAG="v$CLEAN_VERSION"

          echo "IMAGE_TAG=$TAG" >> $GITHUB_OUTPUT
          echo "IMAGE_NAME=${{ secrets.IMAGE_NAME }}" >> $GITHUB_OUTPUT

          echo "ğŸ“¦ Deploy image: ghcr.io/${{ github.repository_owner }}/${{ secrets.IMAGE_NAME }}:$TAG"

      # 3ï¸âƒ£ SSH é…ç½®
      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Add server to known_hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      # 4ï¸âƒ£ æ­£å¼éƒ¨ç½²
      - name: Deploy to server
        env:
          SMARTHIRE_TOKEN: ${{ secrets.SMARTHIRE_TOKEN }}
          IMAGE_NAME: ${{ secrets.IMAGE_NAME }}
          IMAGE_TAG: ${{ steps.get_version.outputs.IMAGE_TAG }}
          REPO_OWNER: ${{ github.repository_owner }}
          GH_ACTOR: ${{ github.event.workflow_run.actor.login }}
        run: |
          ssh -T \
            -o ServerAliveInterval=30 \
            -o ServerAliveCountMax=10 \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << EOF

          set -Eeuo pipefail

          echo "ğŸš€ SmartHire Backend å¼€å§‹éƒ¨ç½²"
          echo "ğŸ“¦ é•œåƒ: ghcr.io/$REPO_OWNER/$IMAGE_NAME:$IMAGE_TAG"

          cd /opt/smarthire/backend

          echo "$SMARTHIRE_TOKEN" | docker login ghcr.io -u "$GH_ACTOR" --password-stdin

          if ! docker image inspect ghcr.io/$REPO_OWNER/$IMAGE_NAME:$IMAGE_TAG > /dev/null 2>&1; then
            echo "â¬‡ï¸ é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ‹‰å–"
            docker pull ghcr.io/$REPO_OWNER/$IMAGE_NAME:$IMAGE_TAG
          else
            echo "âœ… é•œåƒå·²å­˜åœ¨ï¼Œè·³è¿‡ pull"
          fi

          docker tag ghcr.io/$REPO_OWNER/$IMAGE_NAME:$IMAGE_TAG $IMAGE_NAME:latest
          docker-compose up -d --pull never

          echo "âœ… éƒ¨ç½²å®Œæˆ"
          EOF
